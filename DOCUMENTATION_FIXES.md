# æ–‡æ¡£é”™è¯¯ä¿®æ­£æŠ¥å‘Š

> ğŸ“… ç”Ÿæˆæ—¥æœŸ: 2025-10-29  
> ğŸ” æ£€æŸ¥èŒƒå›´: æ‰€æœ‰åç«¯å­¦ä¹ æ–‡æ¡£

## âš ï¸ å‘ç°çš„ä¸»è¦é—®é¢˜

### 1. Handler æ–‡ä»¶è·¯å¾„é”™è¯¯

#### âŒ é”™è¯¯æè¿°
æ–‡æ¡£ä¸­å¼•ç”¨äº†ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼š`api/handler/coze/user.go`

#### âœ… å®é™…æƒ…å†µ
- ç”¨æˆ·ç›¸å…³çš„ Handler åœ¨ `api/handler/coze/passport_service.go`
- Handler æ–‡ä»¶æ˜¯ç”± IDL è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä¸æ˜¯æ‰‹å†™çš„
- æ²¡æœ‰ç‹¬ç«‹çš„ `UserHandler` ç»“æ„ä½“

#### ğŸ“ å—å½±å“çš„æ–‡æ¡£
- `BACKEND_QUICKSTART.md` (è¡Œ 429, 577)
- `BACKEND_LEARNING_GUIDE.md` (è¡Œ 1072)
- `BACKEND_ERRATA.md` (è¡Œ 78)

---

### 2. Repository å®ç°ç±»åé”™è¯¯

#### âŒ é”™è¯¯æè¿°
- æ–‡ä»¶è·¯å¾„é”™è¯¯: `domain/user/internal/dal/user_repo.go`
- ç±»åé”™è¯¯: `userRepoImpl`

#### âœ… å®é™…æƒ…å†µ
- æ­£ç¡®æ–‡ä»¶è·¯å¾„: `domain/user/internal/dal/user.go`
- æ­£ç¡®ç±»å: `UserDAO`
- ä½¿ç”¨ GORM Gen ç”Ÿæˆçš„æŸ¥è¯¢å¯¹è±¡

#### ğŸ“ å—å½±å“çš„æ–‡æ¡£
- `BACKEND_QUICKSTART.md` (è¡Œ 595, 609)
- `BACKEND_ERRATA.md` (è¡Œ 19-20, 26)

---

### 3. Handler è°ƒç”¨æ¨¡å¼é”™è¯¯

#### âŒ é”™è¯¯æè¿°
æ–‡æ¡£ä¸­å±•ç¤ºçš„æ˜¯ç»“æ„ä½“å­—æ®µè°ƒç”¨ï¼š
```go
type UserHandler struct {
    userAppSVC *application.UserApplicationService
}

func (h *UserHandler) GetUserInfo(...) {
    resp, err := h.userAppSVC.GetUserInfo(...)
}
```

#### âœ… å®é™…æƒ…å†µ
å®é™…æ˜¯ç›´æ¥è°ƒç”¨å…¨å±€å˜é‡ï¼š
```go
// æ²¡æœ‰ UserHandler ç»“æ„ä½“

func PassportAccountInfoV2(ctx context.Context, c *app.RequestContext) {
    // ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡
    resp, err := user.UserApplicationSVC.PassportAccountInfoV2(ctx, &req)
}
```

---

### 4. è·¯ç”±æ³¨å†Œæ¨¡å¼é”™è¯¯

#### âŒ é”™è¯¯æè¿°
æ–‡æ¡£ä¸­å±•ç¤ºçš„æ˜¯æ‰‹åŠ¨è·¯ç”±æ³¨å†Œï¼š
```go
func RegisterUserRoutes(r *server.Hertz, handler *UserHandler) {
    user := r.Group("/api/user")
    user.GET("/info", handler.GetUserInfo)
}
```

#### âœ… å®é™…æƒ…å†µ
è·¯ç”±ç”± IDL è‡ªåŠ¨ç”Ÿæˆï¼š
```go
// api/router/coze/api.go (è‡ªåŠ¨ç”Ÿæˆ)
func Register(r *server.Hertz) {
    r.POST("/api/passport/web/email/register/v2/", coze.PassportWebEmailRegisterV2Post)
    r.GET("/api/passport/web/logout/", coze.PassportWebLogoutGet)
    // ...
}
```

---

## ğŸ“ å®é™…çš„é¡¹ç›®æ¶æ„

### Handler å±‚ï¼ˆIDL è‡ªåŠ¨ç”Ÿæˆï¼‰

**æ–‡ä»¶ä½ç½®**: `backend/api/handler/coze/passport_service.go`

```go
// Code generated by hertz generator. DO NOT EDIT.

package coze

import (
    "github.com/coze-dev/coze-studio/backend/api/model/passport"
    "github.com/coze-dev/coze-studio/backend/application/user"
)

// PassportWebEmailRegisterV2Post ç”¨æˆ·æ³¨å†Œ
// @router /passport/web/email/register/v2/ [POST]
func PassportWebEmailRegisterV2Post(ctx context.Context, c *app.RequestContext) {
    var req passport.PassportWebEmailRegisterV2PostRequest
    err := c.BindAndValidate(&req)
    if err != nil {
        invalidParamRequestResponse(c, err.Error())
        return
    }

    // âš ï¸ å…³é”®ï¼šç›´æ¥è°ƒç”¨å…¨å±€å˜é‡
    resp, sessionKey, err := user.UserApplicationSVC.PassportWebEmailRegisterV2(ctx, locale, &req)
    if err != nil {
        internalServerErrorResponse(ctx, c, err)
        return
    }

    c.JSON(http.StatusOK, resp)
}
```

### Application Service å±‚

**æ–‡ä»¶ä½ç½®**: `backend/application/user/user.go`

```go
package user

// âš ï¸ å…¨å±€å˜é‡å•ä¾‹
var UserApplicationSVC = &UserApplicationService{}

type UserApplicationService struct {
    DomainSVC service.User    // é¢†åŸŸæœåŠ¡æ¥å£
    oss       storage.Storage // å¯¹è±¡å­˜å‚¨
}

func (u *UserApplicationService) PassportWebEmailRegisterV2(...) (...) {
    // è°ƒç”¨é¢†åŸŸæœåŠ¡
    _, err = u.DomainSVC.Create(ctx, &user.CreateUserRequest{
        Email:    req.GetEmail(),
        Password: req.GetPassword(),
        Locale:   locale,
    })
    // ...
}
```

### Domain Service å±‚

**æ–‡ä»¶ä½ç½®**: `backend/domain/user/service/user_impl.go`

```go
package service

type Components struct {
    IconOSS   storage.Storage
    IDGen     idgen.IDGenerator
    UserRepo  repository.UserRepository
    SpaceRepo repository.SpaceRepository
}

func NewUserDomain(ctx context.Context, c *Components) User {
    return &userImpl{
        Components: c,
    }
}

type userImpl struct {
    *Components
}
```

### Repository å±‚

**æ–‡ä»¶ä½ç½®**: `backend/domain/user/internal/dal/user.go`

```go
package dal

import (
    "github.com/coze-dev/coze-studio/backend/domain/user/internal/dal/query"
)

func NewUserDAO(db *gorm.DB) *UserDAO {
    return &UserDAO{
        query: query.Use(db),  // GORM Gen æŸ¥è¯¢å¯¹è±¡
    }
}

// âš ï¸ å®é™…ç±»åæ˜¯ UserDAOï¼Œä¸æ˜¯ userRepoImpl
type UserDAO struct {
    query *query.Query  // GORM Gen ç”Ÿæˆ
}

func (dao *UserDAO) GetUserByID(ctx context.Context, userID int64) (*model.User, error) {
    // âš ï¸ ä½¿ç”¨ GORM Gen çš„ç±»å‹å®‰å…¨æŸ¥è¯¢
    return dao.query.User.WithContext(ctx).
        Where(dao.query.User.ID.Eq(userID)).
        First()
}
```

---

## ğŸ”§ éœ€è¦ä¿®æ­£çš„æ–‡ä»¶æ¸…å•

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®æ­£ï¼‰

1. âœ… `BACKEND_QUICKSTART.md` - **å·²ä¿®æ­£**
   - [x] ä¿®æ­£ Layer 8 çš„ Handler ç¤ºä¾‹
   - [x] ä¿®æ­£ Layer 9 çš„è·¯ç”±æ³¨å†Œç¤ºä¾‹
   - [x] ä¿®æ­£"åŠ¨æ‰‹å®è·µ"éƒ¨åˆ†çš„æ–‡ä»¶è·¯å¾„å’Œç±»å
   - [x] æ·»åŠ  "IDL è‡ªåŠ¨ç”Ÿæˆ" çš„è­¦å‘Šè¯´æ˜
   - [x] ä½¿ç”¨å®é™…å­˜åœ¨çš„ API è·¯å¾„
   - [x] ä¿®æ­£æ‰€æœ‰ `user.go` å¼•ç”¨ä¸º `passport_service.go`
   - [x] ä¿®æ­£æ‰€æœ‰ `userRepoImpl` å¼•ç”¨ä¸º `UserDAO`
   - [x] ä¿®æ­£æ‰€æœ‰ `user_repo.go` å¼•ç”¨ä¸º `user.go`

2. â³ `BACKEND_LEARNING_GUIDE.md` - **å¾…ä¿®æ­£**
   - [ ] ä¿®æ­£ Handler ç›¸å…³ç« èŠ‚
   - [ ] æ·»åŠ  IDL ç”Ÿæˆæµç¨‹è¯´æ˜

3. â³ `BACKEND_ERRATA.md` - **å¾…æ›´æ–°**
   - [ ] æ›´æ–°é”™è¯¯è¯´æ˜ï¼Œæ·»åŠ æ›´å¤šç»†èŠ‚
   - [ ] æ˜ç¡®æŒ‡å‡º Handler æ˜¯ IDL ç”Ÿæˆçš„

### ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®æ­£ï¼‰

4. `BACKEND_PRACTICE.md`
   - [ ] ç¡®ä¿æ‰€æœ‰ç¤ºä¾‹ä»£ç ä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶åå’Œç±»å
   - [ ] å¼ºè°ƒ Handler ç”± IDL ç”Ÿæˆ

---

## ğŸ“š å…³é”®è¦ç‚¹æ€»ç»“

### âœ… é¡¹ç›®çš„å®é™…æ¨¡å¼

1. **Handler ç”± IDL è‡ªåŠ¨ç”Ÿæˆ**
   - æ–‡ä»¶: `api/handler/coze/*_service.go`
   - ä¸è¦æ‰‹å†™ Handler ä»£ç 
   - ç›´æ¥è°ƒç”¨å…¨å±€å˜é‡ `user.UserApplicationSVC`

2. **ä½¿ç”¨å…¨å±€å˜é‡å•ä¾‹**
   ```go
   var UserApplicationSVC = &UserApplicationService{}
   ```

3. **Repository ä½¿ç”¨ GORM Gen**
   - ç±»å: `UserDAO`ï¼ˆä¸æ˜¯ `userRepoImpl`ï¼‰
   - æ–‡ä»¶: `domain/user/internal/dal/user.go`

4. **è·¯ç”±ç”± IDL è‡ªåŠ¨ç”Ÿæˆ**
   - æ–‡ä»¶: `api/router/coze/api.go`
   - ä¸è¦æ‰‹åŠ¨æ³¨å†Œè·¯ç”±

### âŒ æ–‡æ¡£ä¸­çš„é”™è¯¯æ¨¡å¼

1. å‡è®¾æ‰‹å†™ Handler ä»£ç 
2. å‡è®¾æœ‰ `UserHandler` ç»“æ„ä½“
3. å‡è®¾æ‰‹åŠ¨æ³¨å†Œè·¯ç”±
4. ä½¿ç”¨é”™è¯¯çš„æ–‡ä»¶åå’Œç±»å

---

## ğŸ¯ ä¿®æ­£è¿›åº¦

1. âœ… åˆ›å»ºæ­¤ä¿®æ­£æŠ¥å‘Š
2. âœ… ä¿®æ­£ `BACKEND_QUICKSTART.md`
   - âœ… Layer 8: Handler ç¤ºä¾‹ï¼ˆä½¿ç”¨å®é™…çš„ passport_service.goï¼‰
   - âœ… Layer 9: è·¯ç”±æ³¨å†Œç¤ºä¾‹ï¼ˆä½¿ç”¨å®é™…çš„ api.goï¼‰
   - âœ… åŠ¨æ‰‹å®è·µéƒ¨åˆ†ï¼ˆä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶è·¯å¾„å’Œç±»åï¼‰
   - âœ… æ·»åŠ äº†å¤šå¤„ âš ï¸ è­¦å‘Šæ ‡è®°
3. â³ ä¿®æ­£ `BACKEND_LEARNING_GUIDE.md`
4. â³ æ›´æ–° `BACKEND_ERRATA.md`
5. â³ æ£€æŸ¥ `BACKEND_PRACTICE.md`

## âœ… å·²ä¿®æ­£çš„å…³é”®ç‚¹

### BACKEND_QUICKSTART.md

#### ä¿®æ­£å‰ âŒ
```
ä½ç½®: api/handler/coze/user.go
type UserHandler struct {
    userAppSVC *application.UserApplicationService
}
```

#### ä¿®æ­£å âœ…
```
ä½ç½®: api/handler/coze/passport_service.goï¼ˆIDL è‡ªåŠ¨ç”Ÿæˆï¼‰
// æ²¡æœ‰ UserHandler ç»“æ„ä½“
// ç›´æ¥è°ƒç”¨å…¨å±€å˜é‡ user.UserApplicationSVC
```

#### ä¿®æ­£å‰ âŒ
```
domain/user/internal/dal/user_repo.go
type userRepoImpl struct {
    db *gorm.DB
}
```

#### ä¿®æ­£å âœ…
```
domain/user/internal/dal/user.go
type UserDAO struct {
    query *query.Query  // GORM Gen
}
```

---

<div align="center">
  <strong>ğŸ“– æ–‡æ¡£è´¨é‡ä¿è¯ ğŸ“–</strong><br>
  <em>ä¸€åˆ‡ä»¥å®é™…ä»£ç ä¸ºå‡†</em>
</div>

