# Coze Studio åç«¯å­¦ä¹ æ–‡æ¡£å‹˜è¯¯è¡¨

> ğŸ”§ å¯¹ç”Ÿæˆçš„å­¦ä¹ æ–‡æ¡£ä¸­çš„é”™è¯¯è¿›è¡Œæ›´æ­£

## ğŸ“‹ æ–‡æ¡£æ›´æ–°è®°å½•

- **2025-01-XX**: å‘ç°å¹¶ä¿®æ­£å¤šå¤„ä¸å®é™…ä»£ç ä¸ç¬¦çš„æè¿°

---

## ğŸ” ä¸»è¦é”™è¯¯å’Œæ›´æ­£

### é”™è¯¯ 1: Repository å®ç°çš„æ–‡ä»¶è·¯å¾„å’Œå‘½å âœ… å·²ä¿®æ­£

**æ–‡æ¡£ä½ç½®**: `BACKEND_QUICKSTART.md` - Layer 5

âŒ **é”™è¯¯æè¿°**:
```
æ–‡ä»¶: domain/user/internal/dal/user_repo.go
ç±»å: userRepoImpl
```

âœ… **å®é™…æƒ…å†µ**:
```
æ–‡ä»¶: domain/user/internal/dal/user.go
ç±»å: UserDAO (ä¸æ˜¯ userRepoImpl)
```

**åŸå› **: é¡¹ç›®ä½¿ç”¨ **GORM Gen** è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼Œé‡‡ç”¨ DAO æ¨¡å¼è€Œéæ‰‹å†™ Repositoryã€‚

---

### é”™è¯¯ 2: Application Service çš„åˆå§‹åŒ–æ–¹å¼

**æ–‡æ¡£ä½ç½®**: `BACKEND_QUICKSTART.md` - Layer 6, `BACKEND_PRACTICE.md`

âŒ **é”™è¯¯æè¿°**:
```go
// æ–‡æ¡£ä¸­æè¿°çš„æ–¹å¼
func InitService(...) *UserApplicationService {
    return &UserApplicationService{
        DomainSVC: domainSVC,
        oss:       oss,
    }
}
```

âœ… **å®é™…æƒ…å†µ**:
```go
// å®é™…ä½¿ç”¨å…¨å±€å˜é‡
var UserApplicationSVC = &UserApplicationService{}

func InitService(ctx context.Context, db *gorm.DB, oss storage.Storage, idgen idgen.IDGenerator) *UserApplicationService {
    UserApplicationSVC.DomainSVC = service.NewUserDomain(ctx, &service.Components{
        IconOSS:   oss,
        IDGen:     idgen,
        UserRepo:  repository.NewUserRepo(db),
        SpaceRepo: repository.NewSpaceRepo(db),
    })
    UserApplicationSVC.oss = oss
    
    return UserApplicationSVC  // è¿”å›å…¨å±€å˜é‡
}
```

**å½±å“**: 
- åº”ç”¨æœåŠ¡æ˜¯å•ä¾‹æ¨¡å¼ï¼Œä½¿ç”¨å…¨å±€å˜é‡
- åˆå§‹åŒ–æ—¶ä¿®æ”¹å…¨å±€å˜é‡çš„å­—æ®µï¼Œè€Œéåˆ›å»ºæ–°å®ä¾‹

---

### é”™è¯¯ 3: Handler çš„ç›®å½•ç»“æ„å’Œç”Ÿæˆæ–¹å¼ âš ï¸ é‡è¦

**æ–‡æ¡£ä½ç½®**: `BACKEND_QUICKSTART.md`, `BACKEND_PRACTICE.md`, `BACKEND_LEARNING_GUIDE.md`

âŒ **é”™è¯¯æè¿°**:
```
1. æ–‡ä»¶è·¯å¾„é”™è¯¯:
   - api/handler/coze/user.go (ä¸å­˜åœ¨)
   - api/handler/coze/knowledge.go (ä¸å­˜åœ¨)
   - api/handler/coze/plugin.go (ä¸å­˜åœ¨)

2. ä»£ç ç»“æ„é”™è¯¯:
   type UserHandler struct {
       userAppSVC *application.UserApplicationService
   }
   
   func (h *UserHandler) GetUserInfo(...) {
       resp, err := h.userAppSVC.GetUserInfo(...)
   }
```

âœ… **å®é™…æƒ…å†µ**:
```
api/handler/coze/
â”œâ”€â”€ passport_service.go      # ç”¨æˆ·è®¤è¯ç›¸å…³ï¼ˆç™»å½•ã€æ³¨å†Œï¼‰
â”œâ”€â”€ knowledge_service.go     # çŸ¥è¯†åº“ Handler
â”œâ”€â”€ plugin_develop_service.go # æ’ä»¶å¼€å‘ Handler
â”œâ”€â”€ workflow_service.go      # å·¥ä½œæµ Handler
â”œâ”€â”€ conversation_service.go  # å¯¹è¯ Handler
â”œâ”€â”€ message_service.go       # æ¶ˆæ¯ Handler
â””â”€â”€ ... (å…¶ä»– *_service.go)

æ‰€æœ‰ Handler ä»£ç éƒ½æ˜¯ç”± Thrift IDL è‡ªåŠ¨ç”Ÿæˆçš„ï¼
```

**å®é™…ä»£ç ç¤ºä¾‹**:
```go
// api/handler/coze/passport_service.go
// âš ï¸ Code generated by hertz generator. DO NOT EDIT.

package coze

// PassportAccountInfoV2 è·å–ç”¨æˆ·è´¦å·ä¿¡æ¯
// @router /api/passport/account/info/v2/ [POST]
func PassportAccountInfoV2(ctx context.Context, c *app.RequestContext) {
    var req passport.PassportAccountInfoV2Request
    err := c.BindAndValidate(&req)
    if err != nil {
        invalidParamRequestResponse(c, err.Error())
        return
    }

    // âš ï¸ å…³é”®ï¼šç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡ï¼Œæ²¡æœ‰ Handler ç»“æ„ä½“
    resp, err := user.UserApplicationSVC.PassportAccountInfoV2(ctx, &req)
    if err != nil {
        internalServerErrorResponse(ctx, c, err)
        return
    }

    c.JSON(http.StatusOK, resp)
}
```

**é‡è¦è¯´æ˜**:
1. âš ï¸ **Handler ä»£ç ç”± IDL è‡ªåŠ¨ç”Ÿæˆ**ï¼Œä¸è¦æ‰‹å†™æˆ–ä¿®æ”¹
2. âš ï¸ **æ²¡æœ‰ Handler ç»“æ„ä½“**ï¼ˆå¦‚ `UserHandler`ï¼‰
3. âš ï¸ **ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡** `user.UserApplicationSVC`
4. âœ… æ–‡ä»¶ä»¥ `_service.go` ç»“å°¾
5. âœ… å¯¹åº” `idl/` ç›®å½•ä¸‹çš„ Thrift æ–‡ä»¶

---

### é”™è¯¯ 4: Domain Entity å’Œ Model çš„å…³ç³»

**æ–‡æ¡£ä½ç½®**: `BACKEND_QUICKSTART.md`

âŒ **é”™è¯¯æè¿°**:
æ–‡æ¡£ä¸­æš—ç¤º Entity å’Œ Model æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œéœ€è¦è½¬æ¢ã€‚

âœ… **å®é™…æƒ…å†µ**:
é¡¹ç›®ä¸­å¾ˆå¤šåœ°æ–¹**ç›´æ¥ä½¿ç”¨** GORM Gen ç”Ÿæˆçš„ `model.User`ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºç‹¬ç«‹çš„ Domain Entityã€‚

**ç¤ºä¾‹**:
```go
// domain/user/repository/repository.go
type UserRepository interface {
    GetUserByID(ctx context.Context, userID int64) (*model.User, error)
    // ç›´æ¥è¿”å› model.Userï¼Œè€Œé entity.User
}
```

**è¯´æ˜**: 
- `entity.User` å’Œ `model.User` åœ¨è¿™ä¸ªé¡¹ç›®ä¸­**éƒ¨åˆ†æ··ç”¨**
- ä¸æ˜¯ä¸¥æ ¼çš„ DO â†’ Entity è½¬æ¢æ¨¡å¼
- Service å±‚å¯èƒ½ç›´æ¥ä½¿ç”¨ `model.User`

---

### é”™è¯¯ 5: Router æ³¨å†Œæ–¹å¼

**æ–‡æ¡£ä½ç½®**: `BACKEND_QUICKSTART.md` - Layer 9

âŒ **é”™è¯¯æè¿°**:
```go
func RegisterUserRoutes(r *server.Hertz, handler *UserHandler) {
    user := r.Group("/api/user")
    {
        user.GET("/info", handler.GetUserInfo)
    }
}
```

âœ… **å®é™…æƒ…å†µ**:
è·¯ç”±æ³¨å†Œæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œåœ¨ `api/router/coze/` ç›®å½•ä¸‹ï¼Œé€šè¿‡ IDL ç”Ÿæˆã€‚

```go
// api/router/register.go
func GeneratedRegister(r *server.Hertz) {
    coze.Register(r)  // è‡ªåŠ¨ç”Ÿæˆçš„è·¯ç”±
    staticFileRegister(r)
}
```

**è¯´æ˜**: 
- è·¯ç”±æ˜¯é€šè¿‡ IDL (Thrift) è‡ªåŠ¨ç”Ÿæˆçš„
- ä¸éœ€è¦æ‰‹åŠ¨ç¼–å†™è·¯ç”±æ³¨å†Œä»£ç 
- ä¿®æ”¹ IDL æ–‡ä»¶åé‡æ–°ç”Ÿæˆ

---

### é”™è¯¯ 6: æµ‹è¯•ä»£ç ç¤ºä¾‹

**æ–‡æ¡£ä½ç½®**: `BACKEND_PRACTICE.md` - å•å…ƒæµ‹è¯•éƒ¨åˆ†

âŒ **é”™è¯¯æè¿°**:
ä½¿ç”¨ `gomock` åˆ›å»º Mockã€‚

âœ… **å®é™…æƒ…å†µ**:
é¡¹ç›®å¯èƒ½ä½¿ç”¨ `go.uber.org/mock` æˆ–å…¶ä»– mock å·¥å…·ï¼Œè¯­æ³•å¯èƒ½ç•¥æœ‰ä¸åŒã€‚

**å»ºè®®**: å‚è€ƒé¡¹ç›®ä¸­å·²æœ‰çš„æµ‹è¯•ä»£ç ï¼Œå¦‚:
- `backend/application/conversation/openapi_agent_run_test.go`
- `backend/application/workflow/workflow_test.go`

---

## ğŸ¯ é‡è¦æ¦‚å¿µæ›´æ­£

### 1. GORM Gen çš„ä½¿ç”¨

**å…³é”®ç‚¹**:
```go
// ç±»å‹å®‰å…¨çš„æŸ¥è¯¢
dao.query.User.Where(dao.query.User.ID.Eq(userID)).First()

// è€Œä¸æ˜¯å­—ç¬¦ä¸²æŸ¥è¯¢
db.Where("user_id = ?", userID).First(&user)
```

**ç”Ÿæˆçš„æ–‡ä»¶ä½ç½®**:
```
domain/*/internal/dal/
â”œâ”€â”€ model/*.gen.go    # ç”Ÿæˆçš„æ¨¡å‹
â””â”€â”€ query/*.gen.go    # ç”Ÿæˆçš„æŸ¥è¯¢ä»£ç 
```

---

### 2. åº”ç”¨æœåŠ¡çš„å…¨å±€å˜é‡æ¨¡å¼

**å®é™…æ¨¡å¼**:
```go
// æ¯ä¸ªåº”ç”¨æœåŠ¡éƒ½æ˜¯å…¨å±€å•ä¾‹
var (
    UserApplicationSVC        = &UserApplicationService{}
    KnowledgeApplicationSVC   = &KnowledgeApplicationService{}
    WorkflowApplicationSVC    = &WorkflowApplicationService{}
)

// åˆå§‹åŒ–æ—¶ä¿®æ”¹å…¨å±€å˜é‡
func InitService(...) *XXXApplicationService {
    XXXApplicationSVC.field1 = value1
    XXXApplicationSVC.field2 = value2
    return XXXApplicationSVC
}
```

**å½±å“**:
- æ‰€æœ‰æœåŠ¡éƒ½æ˜¯å•ä¾‹
- ä¸éœ€è¦åˆ°å¤„ä¼ é€’æœåŠ¡å®ä¾‹
- ä½†æµ‹è¯•æ—¶éœ€è¦å°å¿ƒé‡ç½®çŠ¶æ€

---

### 3. IDL é©±åŠ¨çš„å¼€å‘

**å…³é”®æµç¨‹**:
```
1. ç¼–å†™ IDL æ–‡ä»¶ (Thrift)
   â†“
2. ç”Ÿæˆä»£ç  (è·¯ç”±ã€Handler ç­¾åã€Model)
   â†“
3. å®ç° Handler é€»è¾‘
   â†“
4. å®Œæˆå¼€å‘
```

**æ–‡ä»¶ä½ç½®**:
- IDL å®šä¹‰: `idl/*.thrift`
- ç”Ÿæˆçš„ä»£ç : `api/model/`, `api/router/`

---

## ğŸ“ æ–‡æ¡£ä¿®æ­£å»ºè®®

### BACKEND_QUICKSTART.md

**éœ€è¦ä¿®æ­£**:
1. âœ… Repository å®ç°éƒ¨åˆ† (å·²ä¿®æ­£)
2. âš ï¸ Application Service åˆå§‹åŒ–ç¤ºä¾‹
3. âš ï¸ Handler ç¤ºä¾‹ä»£ç 
4. âš ï¸ Router æ³¨å†Œç¤ºä¾‹

**å»ºè®®**:
- æ·»åŠ  GORM Gen ä½¿ç”¨è¯´æ˜
- å¼ºè°ƒå…¨å±€å˜é‡å•ä¾‹æ¨¡å¼
- è¯´æ˜ IDL é©±åŠ¨å¼€å‘æµç¨‹

---

### BACKEND_LEARNING_GUIDE.md

**éœ€è¦ä¿®æ­£**:
1. âš ï¸ Repository å®ç°éƒ¨åˆ†çš„æè¿°
2. âš ï¸ Application å±‚çš„åˆå§‹åŒ–è¯´æ˜
3. âš ï¸ æµ‹è¯•ä»£ç ç¤ºä¾‹

**å»ºè®®**:
- æ·»åŠ  "å®é™…é¡¹ç›®ç‰¹ç‚¹" ç« èŠ‚
- è¯´æ˜ä¸æ ‡å‡† DDD çš„å·®å¼‚
- æä¾›æ›´å¤šå®é™…ä»£ç é“¾æ¥

---

### BACKEND_PRACTICE.md

**éœ€è¦ä¿®æ­£**:
1. âš ï¸ æ•´ä¸ªå®æˆ˜é¡¹ç›®çš„ä»£ç ç¤ºä¾‹
2. âš ï¸ åˆå§‹åŒ–ä»£ç 
3. âš ï¸ Handler å®ç°
4. âš ï¸ è·¯ç”±æ³¨å†Œ

**å»ºè®®**:
- å®Œå…¨é‡å†™ï¼ŒåŸºäºå®é™…é¡¹ç›®æ¨¡å¼
- ä½¿ç”¨ GORM Gen è€Œéæ‰‹å†™ DAO
- ä½¿ç”¨å…¨å±€å˜é‡æ¨¡å¼
- è¯´æ˜ IDL æ–‡ä»¶çš„ç¼–å†™

---

## âœ… æ­£ç¡®çš„å¼€å‘æµç¨‹

### æ·»åŠ æ–°åŠŸèƒ½çš„å®é™…æ­¥éª¤

#### 1. ç¼–å†™ IDL æ–‡ä»¶

```thrift
// idl/user_tag.thrift
namespace go user_tag

struct CreateTagRequest {
    1: required i64 space_id
    2: required string name
    3: optional string color
    4: optional string description
}

struct CreateTagResponse {
    1: required i64 tag_id
    2: required string name
}

service UserTagService {
    CreateTagResponse CreateTag(1: CreateTagRequest req)
}
```

#### 2. ç”Ÿæˆä»£ç 

```bash
# ç”Ÿæˆ API Model å’Œ Router
make idl_gen
```

#### 3. åˆ›å»º Domain Entity

```go
// domain/user/entity/user_tag.go
type UserTag struct {
    ID          int64
    SpaceID     int64
    Name        string
    Color       string
    Description string
    CreatedAt   int64
    UpdatedAt   int64
}
```

#### 4. å®šä¹‰ Repository (ä½¿ç”¨ GORM Gen)

```go
// domain/user/repository/repository.go
type UserTagRepository interface {
    CreateTag(ctx context.Context, tag *model.UserTag) error
    GetTagByID(ctx context.Context, id int64) (*model.UserTag, error)
}
```

#### 5. å®ç° DAO

```go
// domain/user/internal/dal/user_tag.go
type UserTagDAO struct {
    query *query.Query
}

func NewUserTagDAO(db *gorm.DB) *UserTagDAO {
    return &UserTagDAO{
        query: query.Use(db),
    }
}

func (dao *UserTagDAO) CreateTag(ctx context.Context, tag *model.UserTag) error {
    return dao.query.UserTag.WithContext(ctx).Create(tag)
}
```

#### 6. å®ç° Domain Service

```go
// domain/user/service/user_tag_service.go
type UserTagService interface {
    CreateTag(ctx context.Context, req *CreateTagRequest) (*entity.UserTag, error)
}

type userTagServiceImpl struct {
    tagRepo repository.UserTagRepository
}
```

#### 7. åˆ›å»º Application Service (å…¨å±€å˜é‡)

```go
// application/user/user_tag.go
var UserTagApplicationSVC = &UserTagApplicationService{}

type UserTagApplicationService struct {
    tagSVC service.UserTagService
}

func InitUserTagService(tagSVC service.UserTagService) *UserTagApplicationService {
    UserTagApplicationSVC.tagSVC = tagSVC
    return UserTagApplicationSVC
}
```

#### 8. å®ç° Handler

```go
// api/handler/coze/user_tag_service.go
// æ³¨æ„ï¼šHandler æ–¹æ³•ç­¾åç”± IDL ç”Ÿæˆï¼Œéœ€è¦åŒ¹é…
func (h *UserTagHandler) CreateTag(ctx context.Context, c *app.RequestContext, req *api_model.CreateTagRequest) (*api_model.CreateTagResponse, error) {
    // å®ç°é€»è¾‘
    return UserTagApplicationSVC.CreateTag(ctx, req)
}
```

#### 9. è·¯ç”±è‡ªåŠ¨ç”Ÿæˆ

è·¯ç”±ä¼šåœ¨ `make idl_gen` æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œä¸éœ€è¦æ‰‹å†™ã€‚

---

## ğŸ”— å‚è€ƒå®é™…ä»£ç 

### æ­£ç¡®çš„ä»£ç ç¤ºä¾‹ä½ç½®

1. **DAO å®ç°**: `backend/domain/user/internal/dal/user.go`
2. **Domain Service**: `backend/domain/user/service/user_impl.go`
3. **Application Service**: `backend/application/user/user.go`
4. **Handler**: `backend/api/handler/coze/passport_service.go`
5. **åˆå§‹åŒ–**: `backend/application/user/init.go`

---

## ğŸ“š å»ºè®®å­¦ä¹ é¡ºåºï¼ˆæ›´æ­£åï¼‰

1. **ç†è§£ GORM Gen** - é˜…è¯» `domain/user/internal/dal/`
2. **ç†è§£å…¨å±€å˜é‡æ¨¡å¼** - é˜…è¯» `application/user/init.go`
3. **ç†è§£ IDL é©±åŠ¨** - æŸ¥çœ‹ `idl/` ç›®å½•
4. **é˜…è¯»å®é™…ä»£ç ** - ä» User é¢†åŸŸå¼€å§‹
5. **å‚è€ƒç°æœ‰æµ‹è¯•** - å­¦ä¹ æµ‹è¯•å†™æ³•

---

## âš ï¸ é‡è¦æé†’

### æ–‡æ¡£ vs å®é™…ä»£ç 

å­¦ä¹ æ–‡æ¡£æä¾›äº† **ç†æƒ³åŒ–çš„ DDD æ¶æ„** æè¿°ï¼Œä½†å®é™…é¡¹ç›®ä¸­ï¼š

- âœ… **æ¶æ„æ€æƒ³æ˜¯å¯¹çš„** (åˆ†å±‚ã€ä¾èµ–å€’ç½®)
- âš ï¸ **å®ç°æ–¹å¼æœ‰å·®å¼‚** (GORM Genã€å…¨å±€å˜é‡ã€IDL é©±åŠ¨)
- ğŸ’¡ **ä»¥å®é™…ä»£ç ä¸ºå‡†** 

### å­¦ä¹ å»ºè®®

1. **å…ˆç†è§£æ¶æ„æ€æƒ³** - é˜…è¯»å­¦ä¹ æ–‡æ¡£
2. **å†çœ‹å®é™…å®ç°** - é˜…è¯»æºä»£ç 
3. **å¯¹æ¯”å·®å¼‚** - ç†è§£ä¸ºä»€ä¹ˆä¸åŒ
4. **å®è·µä¸­å­¦ä¹ ** - æ¨¡ä»¿ç°æœ‰ä»£ç 

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### å¯¹äºå­¦ä¹ è€…

1. âœ… é˜…è¯»æœ¬å‹˜è¯¯è¡¨
2. âœ… å‚è€ƒå®é™…ä»£ç ç¤ºä¾‹
3. âœ… ä»ç®€å•çš„ User é¢†åŸŸå¼€å§‹
4. âœ… é€æ­¥ç†è§£é¡¹ç›®ç‰¹ç‚¹

### å¯¹äºæ–‡æ¡£ç»´æŠ¤è€…

- [ ] é‡å†™ `BACKEND_PRACTICE.md` çš„å®æˆ˜é¡¹ç›®
- [ ] æ›´æ–° `BACKEND_QUICKSTART.md` çš„ç¤ºä¾‹ä»£ç 
- [ ] æ·»åŠ  "é¡¹ç›®ç‰¹ç‚¹" ç« èŠ‚åˆ°å­¦ä¹ æŒ‡å—
- [ ] è¡¥å…… GORM Gen å’Œ IDL çš„ä½¿ç”¨è¯´æ˜

---

**æœ€åæ›´æ–°**: 2025-01-XX

**åé¦ˆ**: å¦‚æœå‘ç°æ›´å¤šé”™è¯¯ï¼Œè¯·æäº¤ Issue æˆ– PR

